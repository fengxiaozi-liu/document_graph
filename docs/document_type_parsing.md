# 文档类型解析策略（Parsing Spec）

本文档定义 document_graph 的文档解析与清洗策略，涵盖支持的文件类型、限制、错误处理与性能注意事项。后续新增解析能力时优先在此文档更新。

## 总体流程（适用于所有类型）

1) 类型识别：基于上传文件名、`mime_type`、`file_ext` 以及必要的内容探测。
2) 文本抽取：抽取可检索正文与必要元数据（标题/段落/表格标题等）。
3) 清洗与规范化：去除重复、噪声、无意义导航文本，统一空白与编码。
4) 切分与索引：进入 chunking 与 embedding 流水线。

## 文件类型与解析策略

### Markdown（.md）

- 策略：基于标题层级（#..######）构建 `title_path`，按段落拆分文本。
- 适配场景：研发文档、系统设计文档。
- 限制：复杂嵌套表格/代码块可能需要专用切分增强。

### TXT（.txt）

- 策略：按段落/空行切分；保留原始顺序。
- 限制：无结构时检索质量依赖 chunking 参数。

### HTML（.html/.htm）

- 策略：抽取正文文本，过滤导航栏/脚本/样式；尽可能保留标题层级。
- 限制：网页结构多样，正文提取存在误差；需逐步引入更稳健的正文提取器。

### PDF（.pdf）

- 策略：优先使用文本型 PDF 解析器抽取正文；保留页码/段落顺序信息。
- 依赖：`pypdf`。
- 扫描型 PDF：需 OCR 才能提取文本，否则无法索引。
- 限制：
  - 版式复杂（多栏/图表）时顺序可能混乱。
  - 嵌入图片中的文字需要 OCR。

### DOCX（.docx）

- 策略：基于段落与标题层级抽取正文；表格内容可按行展开为文本。
- 依赖：`python-docx`。
- 限制：
  - 内嵌图片/图表默认不解析。
  - 样式层级不一致会影响 `title_path` 质量。

### DOC（.doc，暂不支持）

- 当前默认不支持 `.doc`，需要额外的系统级依赖与旧版解析库。
- 如必须支持，可单独接入专用解析器并补充依赖说明。

### 图片（.png/.jpg/.jpeg 等，暂不支持）

- 当前版本不做单独图片解析；图片文件默认不进入索引。
- 后续如引入 OCR 或多模态解析，可在本节补充策略与限制。

## 错误处理

- 解析失败：任务状态标记为 `failed`，记录错误类型与信息，便于 UI 展示与重试。
- 无法抽取文本：视为失败或进入降级逻辑（例如仅存元数据，不入索引）。
- 解析依赖缺失：返回可读错误，提示安装所需依赖或系统工具。
- OCR/多模态超时：可配置超时与重试次数，避免阻塞主流程。

## 性能注意事项

- 大文件：建议在解析阶段做大小限制或拆分，避免一次性全量载入内存。
- OCR 与多模态：计算成本高，建议异步处理并做缓存。
- 批量上传：任务队列需限制并发与批大小，避免外部服务（Embedding/LLM）限流。

## 后续扩展建议

- 引入可配置解析器链（按类型选择策略）。
- 为 HTML/PDF/DOCX 引入可选的正文提取/结构化解析器。
- 为图片引入 OCR 结果的置信度评分与过滤。
